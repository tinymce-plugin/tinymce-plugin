 /**
 * attachment (Enhancement 1.6v) 2021-07-18
 * 
 * 
 * https://github.com/Five-great/tinymce-plugins
 * 
 * Copyright 2021, Five(Li Hailong) The Chengdu, China https://www.fivecc.cn/
 *
 * Licensed under MIT
 */
!function(){function t(a,c){if(void 0===c&&(c=2),0===a)return"0 B";var b=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,b)).toFixed(0>c?0:c))+" "+"BKMGTPEZY".split("")[b]}function r(a){a.focus();A(u).then(function(c){for(var b=0;b<c.length;b++)v(a,c[b],function(f,k){console.log(k);0<a.dom.select("span#"+f).length?a.dom.replace(k,f):a.selection.setContent(k.outerHTML)})})}function B(a){u=a;a.ui.registry.getAll().icons.attachment||a.ui.registry.addIcon("attachment",'<svg width="20" height="20"><path d="M16.3 9.3a.8.8 0 00-1 0l-5.5 5.4a2.8 2.8 0 01-4.3-.4v-.1l-.2-.3-.1-.2a3 3 0 01-.2-.6V13c0-.9.2-1.7.8-2.2L11.7 5c.6-.7 1.6-.7 2.3 0a1.6 1.6 0 010 2.2L8 13a.4.4 0 01-.7-.3v-.3L12.2 8c.3-.3.3-.8 0-1a.8.8 0 00-1 0l-4.7 4.5a1.9 1.9 0 000 2.7c.8.7 2 .7 2.8 0L15 8.3a3 3 0 000-4.4 3.1 3.1 0 00-4.4 0L4.8 9.7a4.2 4.2 0 000 6 4.3 4.3 0 006 0l5.5-5.3.2-.6c0-.2 0-.4-.2-.5" fill-rule="evenodd"/></svg>');
a.ui.registry.addButton("attachment",{icon:"attachment",tooltip:"\u63d2\u5165\u9644\u4ef6",onAction:function(){return r(a)}});a.ui.registry.addMenuItem("attachment",{icon:"attachment",text:"\u63d2\u5165\u9644\u4ef6",onAction:function(){return r(a)}});a.ui.registry.addButton("attachment-download",{text:"\u4e0b\u8f7d",onAction:function(){a:{var c=0;for(var b=a.selection.getNode().children;c<b.length;c++){var f=b[c];if(f.hasAttribute("href")){c=f.getAttribute("href");break a}}c="#"}b=c;c=document.createElement("a");
c.target="_blank";c.href=b;c.rel="noreferrer noopener";b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null);document.body.appendChild(c);c.dispatchEvent(b);document.body.removeChild(c)}});a.ui.registry.addContextToolbar("attachment",{predicate:function(c){return!(c=c||a.selection.getNode(),!a.dom.getParent(c,'span[class="attachment"]'))},items:"attachment-download",position:"node",scope:"node"})}var u=null,C=tinymce.util.Tools.resolve("tinymce.util.Promise"),
D=tinymce.util.Tools.resolve("tinymce.Env"),E=tinymce.util.Tools.resolve("tinymce.util.Delay"),A=function(a){return new C(function(c){var b=document.createElement("input");b.type="file";b.setAttribute("multiple","multiple");b.style.position="fixed";b.style.left="0";b.style.top="0";b.style.opacity="0.001";document.body.appendChild(b);b.addEventListener("change",function(k){c(Array.prototype.slice.call(k.target.files))});var f=function(k){var g=function(){c([]);b.parentNode.removeChild(b)};D.os.isAndroid()&&
"remove"!==k.type?E.setEditorTimeout(a,g,0):g();a.off("focusin remove",f)};a.on("focusin remove",f);b.click()})},v=function(a,c,b){var f,k,g,m,p,q,w,x,n,y=a.getParam("attachment_max_size")||209715200;c.size>y?(f=t(y),a.notificationManager.open({text:"\u9644\u4ef6\u6700\u5927\u652f\u6301 "+f+"\uff0c\u8d85\u8fc7 "+f+" \u7684\u9644\u4ef6\u5c06\u4e0d\u4f1a\u88ab\u4e0a\u4f20\u3002",type:"warning",timeout:5E3})):(k=a.getParam("attachment_upload_handler"),g=a.getParam("attachment_icons_path","./plugins/attachment/icons"),
m=a.dom.uniqueId(),p="attachment_"+m,q=t(c.size),w=g+"/"+function(d){if(d){var e=d.lastIndexOf(".");if(-1===e)return"default_file.svg";d=d.substr(e+1).toLowerCase();e=0;for(var h=[{ext:"txt",icon:"file_type_text"},{ext:"doc",icon:"file_type_word2"},{ext:"docx",icon:"file_type_word2"},{ext:"pdf",icon:"file_type_pdf2"},{ext:"xls",icon:"file_type_excel2"},{ext:"xlsx",icon:"file_type_excel2"},{ext:"ppt",icon:"file_type_powerpoint2"},{ext:"pptx",icon:"file_type_powerpoint2"},{ext:"ai",icon:"file_type_ai2"},
{ext:"psd",icon:"file_type_photoshop2"},{ext:"zip",icon:"file_type_zip"},{ext:"rar",icon:"file_type_zip"},{ext:"jpg",icon:"file_type_image"},{ext:"jpeg",icon:"file_type_image"},{ext:"png",icon:"file_type_image"},{ext:"gif",icon:"file_type_image"},{ext:"js",icon:"file_type_js"},{ext:"xml",icon:"file_type_xml"},{ext:"htm",icon:"file_type_html"},{ext:"html",icon:"file_type_html"},{ext:"json",icon:"file_type_light_json"},{ext:"fon",icon:"file_type_light_font"},{ext:"font",icon:"file_type_light_font"},
{ext:"svg",icon:"file_type_image"},{ext:"exe",icon:"file_type_binary"},{ext:"bin",icon:"file_type_binary"},{ext:"dll",icon:"file_type_binary"},{ext:"pkg",icon:"file_type_package"},{ext:"wav",icon:"file_type_audio"},{ext:"mp3",icon:"file_type_audio"},{ext:"mp4",icon:"file_type_video"},{ext:"mov",icon:"file_type_video"},{ext:"avi",icon:"file_type_video"},{ext:"java",icon:"file_type_java"},{ext:"cs",icon:"file_type_csharp"},{ext:"css",icon:"file_type_css"},{ext:"py",icon:"file_type_python"},{ext:"sln",
icon:"file_type_vscode3"},{ext:"go",icon:"file_type_go"},{ext:"7z",icon:"file_type_zip"},{ext:"sketch",icon:"file_type_sketch"},{ext:"patch",icon:"file_type_patch"},{ext:"org",icon:"file_type_org"},{ext:"md",icon:"file_type_markdown"},{ext:"jar",icon:"file_type_jar"},{ext:"dmg",icon:"file_type_dmg"},{ext:"accdb",icon:"file_type_access"},{ext:"apk",icon:"file_type_apk"},{ext:"eps",icon:"file_type_eps"},{ext:"ico",icon:"file_type_ico"},{ext:"iso",icon:"file_type_iso"},{ext:"key",icon:"file_type_keynote"},
{ext:"numbers",icon:"file_type_number"},{ext:"reg",icon:"file_type_reg"},{ext:"rp",icon:"file_type_rp"},{ext:"rtf",icon:"file_type_rtf"},{ext:"sketch",icon:"file_type_sketch"},{ext:"swf",icon:"file_type_swf"},{ext:"url",icon:"file_type_url"},{ext:"wma",icon:"file_type_wma"},{ext:"xmind",icon:"file_type_xmind"},{ext:"cat",icon:"file_type_cat"}];e<h.length;e++){var l=h[e];if(l.ext===d)return l.icon+".svg"}}return"default_file.svg"}(c.name),x=g+"/error.png",n=function(d,e){var h=document.createElement("img");
h.setAttribute("src",e.icon);h.setAttribute("width","30px");var l=document.createElement("span");l.setAttribute("id","progress_"+e.id);l.innerText="0%";var z=document.createElement("span");z.innerText=e.title+" ("+e.size+")";d=d.dom.create("span",{id:"attachment_"+e.id,class:"attachment upload_progress"});return d.appendChild(h),d.appendChild(l),d.appendChild(z),d.contentEditable="false",d}(a,{id:m,icon:g+"/loading.gif",title:c.name,size:q}),b(p,n),k(c,function(d){var e=c.name,h=document.createElement("img");
h.setAttribute("src",w);h.setAttribute("width","30px");var l=document.createElement("a");l.innerText=e+" ("+q+")";l.setAttribute("href",d);d=a.dom.create("span",{id:"attachment_"+m,class:"attachment"});n=(d.appendChild(h),d.appendChild(l),d.contentEditable="false",d);b(p,n)},function(d){console.log(d);var e=c.name,h=document.createElement("img");h.setAttribute("src",x);h.setAttribute("width","30px");var l=document.createElement("span");l.innerText=d+" - "+e+" ("+q+")";d=a.dom.create("span",{class:"attachment upload_error"});
n=(d.appendChild(h),d.appendChild(l),d.contentEditable="false",d);b(p,n)},function(d){var e=a.dom.select("span#progress_"+m);a.dom.setHTML(e,d)}))};tinymce.PluginManager.add("attachment",function(a,c){a.__proto__.getContent=function(b){return function(){return arguments&&0==arguments.length?"<style>"+a.getParam("attachment_style",".attachment>img{display:inline-block!important;max-width:30px!important;}.attachment>a{display:contents!important;}","string")+"</style>"+b.apply(this,arguments).replace(/<style>([\S\s\t]*?)<\/style>/gi,
""):b.apply(this,arguments)}}(a.__proto__.getContent);B(a);a.addCommand("mceAttachment",function(){r(a)});a.on("drop",function(b){b=b.dataTransfer;if(null!=b&&(b=b.files,null!=b))for(var f=0;f<b.length;f++){var k=b[f];(function(g){var m=g.lastIndexOf(".");if(-1===m)return!1;g=g.substr(m);return/.(gif|jpe?g|png)$/i.test(g)})(k.name)||v(a,k,function(g,m){0<a.dom.select("span#"+g).length?a.dom.replace(m,g):a.selection.setContent(m.outerHTML)})}})});return{getMetadata:function(){return{name:pluginName,
url:"https://github.com/Five-great/tinymce-plugins"}}}}();